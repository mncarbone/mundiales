<!DOCTYPE html>
<html>
    <head>
        <title>Brasil 2014</title>
        <script src="http://cdn.app-framework-software.intel.com/2.1/appframework.min.js" type="text/javascript"></script>
        <script src="ui/appframework.ui.js" type="text/javascript"></script>
		<link rel="stylesheet" type="text/css" href="ui/css/af.ui.css" title="default"/>
		<link rel="stylesheet" type="text/css" href="ui/css/af.ui-2.css" title="default"/>
		<link rel="stylesheet" type="text/css" href="ui/css/icons.min.css" title="default"/>
		<link rel="stylesheet" href="css/flags.css" />
		<script type="text/javascript" charset="utf-8" src="cordova.js"></script>		
		<script type="text/javascript" src="js/app.js"></script>	
		<script type="text/javascript" >
		
			function guardar(variable, dato){
				if(window.localStorage && window.localStorage.setItem){
					window.localStorage.setItem(variable, JSON.stringify(dato));
				}
			}

			function leer(variable, defval){
				if(window.localStorage && window.localStorage.getItem){
					var value = window.localStorage.getItem(variable);
					if(value == null){
						return defval;
					}
					else {
						return JSON.parse(value);
					}
				}
				return defval;
			}
			
			var partidos = '';//leer('partidos', '');
			var participantes = '';//leer('participantes', '');
			var torneo = '';
			$.ui.useOSThemes=false;
			$.ui.ready(function(){
			
				document.addEventListener("backbutton", function(e){
					if($.ui.activeDiv.id =='main'){
                        e.preventDefault();
                        navigator.app.exitApp();					
					}
			        else {
                        navigator.app.backHistory();
                    }
                }, false);
			
				//$.ui.showBackButton=false
				$.ui.backButtonText=' ';

				refresh();
			});
			
			setInterval(refresh, 120000);
			
			function refresh(){
			
				$.getJSON("http://worldcup.sfg.io/matches?by_date=ASC",{},function(data){
					partidos = data
					actualizarDatos();
				});
				$.getJSON('http://jsonblob.com/api/jsonBlob/53ad7745e4b07a1c9f44e5a6',{},function(data){
					participantes = data;
					actualizarDatos();
				});
				
				$( "#lstposiciones li" ).show();

			}
			
			function actualizarDatos(){
				var actualizar = false;
				if(participantes != '' && partidos != ''){
					if(torneo == ''){
						torneo = new Torneo(participantes, partidos);
						actualizar = true;
					}
					else{
						actualizar = torneo.actualizar(participantes, partidos);
					} 
					if(actualizar){
						guardar('participantes', participantes);
						guardar('partidos', partidos);					
						cargarPartidos();
						cargarPosiciones();
					}
				}
			}
			
			function cargarPartidos(){
				$( "#lstpartidos" ).html('');
				$( "#lstgrupos" ).html('');
				var ultimaFecha = '';
				var partidos = torneo.getPartidos();
				for(idPartido in partidos) {
					var partido2daFase = (idPartido > 48);
					
					//if(partido2daFase){
						var lista = (partido2daFase)? '#lstpartidos' : '#lstgrupos';
						partido = partidos[idPartido];
						
						if(partido.dia != ultimaFecha){
						//	var txtLEV = (partido2daFase)? '<span class="ui-li-count" style="color:gray;"> L | E | V </span>' : '';
							$( lista ).append($('<li class="divider" >'+partido.dia+'</li>'));
							ultimaFecha = partido.dia;
						}
						
						var txt = '<small>'+partido.hora+'</small>&nbsp;&nbsp;';
						txt += partidoHTML(partido);
						/* */
						if(partido2daFase){
							var tl = partido.cantApuestasPor('L');
							var te = partido.cantApuestasPor('E');
							var tv = partido.cantApuestasPor('V');

							txtApuestas = '<a href="#posiciones" data-transition="slide" onclick="filtrarApostadores(1,'+partido.id+')">&nbsp;'+tl+'&nbsp;</a> | ';
							txtApuestas+= '<a href="#posiciones" data-transition="slide" onclick="filtrarApostadores(0,'+partido.id+')">&nbsp;'+te+'&nbsp;</a> | ';
							txtApuestas+= '<a href="#posiciones" data-transition="slide" onclick="filtrarApostadores(-1,'+partido.id+')">&nbsp;'+tv+'&nbsp;</a>';
							txt += '<span class="af-badge ml">'+txtApuestas+'</span>';
						}
						/* */
						$(lista).append($('<li>'+txt+'</li>'));
					//}
				};            
			}
			
			function cargarPosiciones(){
				var ver = true;
				$( "#lstposiciones" ).html('');
				$("#lstposiciones").append($('<li class="divider" >Participante<span class="af-badge" style="color:gray;">Puntos</span></li>'));
				
				var participantes = torneo.getParticipantes();
				var tot = participantes.length;
				for(var i = 0; i < tot; i++) {
					participante = participantes[i];
					var txt = '<a href="#apuestas" onclick="cargarApuestas('+participante.id+')">'+(i+1)+'. '+participante.nombre+'</a>';
					txt += '<span class="af-badge ml">'+participante.getPuntos()+'</span>';
					$("#lstposiciones").append($('<li id="pos_'+participante.id+'">'+txt+'</li>'));
				}
			}
			
			function partidoHTML(partido){
				var txt = '';
				txt += '<img src="img/blank.gif" class="flag flag-'+partido.local.getBandera()+'"> ';		
				txt += partido.local.codigo;
				txt += ' <big>' + partido.golesLocal + '</big> ';
				txt += ' : ';
				txt += ' <big>' + partido.golesVisitante + '</big> ';
				txt += partido.visitante.codigo;
				txt += ' <img src="img/blank.gif" class="flag flag-'+partido.visitante.getBandera()+'">';	
				return txt;
			}
			
			function cargarApuestas(idParticipante){
				var participante = torneo.getParticipante(idParticipante);
				$("#lstapuestas").html('');
				
				$("#apuestas").data("title", participante.nombre);
				
				$("#lstapuestas").append($('<li class="divider" >Resultado<span class="af-badge" style="color:gray;">Apuesta &rarr; Puntos</span></li>'));				
				var total = 0;
				
				for(var i in participante.apuestas) {
					var apuesta = participante.apuestas[i];
					var partido = apuesta.getPartido();
					var txt = partidoHTML(partido);
					var puntos = apuesta.getPuntos();
					total += puntos;
					
					txt += '<span class="af-badge ml">&nbsp;' 
					txt += apuesta.golesLocal+ ' - '+ apuesta.golesVisitante;
					txt += '&nbsp;&nbsp;&rarr;&nbsp;&nbsp;<big>'+puntos+'&nbsp;</big>';
					txt += '</span>';
					
					$('#lstapuestas').append($('<li>'+txt+'</li>'));
				};
				
				$("#lstapuestas").append($('<li class="divider"><b>Total</b><span class="af-badge"><big>'+total+'</big> puntos</span></li>'));
			}
			
			function filtrarApostadores(resultado, idPartido){
                $( "#lstposiciones li" ).show();
				var resultado =  (resultado > 0)? 'L' : ((resultado < 0)?'V':'E');
				var participantes = torneo.getParticipantes();
				var partido = torneo.getPartido(idPartido);
				var tot = participantes.length;
				for(var i = 0; i < tot; i++) {
					var participante = participantes[i];
					var apuesta = participante.apuestaPara(partido);
					if(apuesta.getResultado() != resultado){
						$('#pos_'+participante.id).hide();
					}
				}					
			}
			
		</script>	
    </head>
	<body>
        <div id="afui">
            <div id="header">
            <a id="backButton" href="javascript:;" class="button previous" style="visibility: hidden; "></a>
            <h1 id="pageTitle">Page Title</h1>
            </div>
            
            <div id="apuestas" data-title="Apuestas" class="panel" selected="false">
                <ol id="lstapuestas" class="list">
                    <p align="center"><img src="css/images/ajax-loader.gif" /></p>
                </ol>
            </div>
            
            <div id="posiciones" data-title="Posiciones" class="panel" selected="false">
                <ol id="lstposiciones" class="list">
                    <p align="center"><img src="css/images/ajax-loader.gif" /></p>
                </ol>
            </div>
            
            <div id="grupos" data-title="Grupos" class="panel" selected="false"  >
                <ul id="lstgrupos" class="list">
                    <p align="center"><img src="css/images/ajax-loader.gif" /></p>
                </ul>
            </div>
                        
            <div id="main" data-title="Partidos" class="panel" selected="true"  >
                <ul id="lstpartidos" class="list">
                    <p align="center"><img src="css/images/ajax-loader.gif" /></p>
                </ul>
            </div>

            <div id="navbar">
                <a href="#main" class="icon home" onclick="refresh()">Partidos</a>
                <a href="#grupos" class="icon calendar" onclick="refresh()">Grupos</a>
                <a href="#posiciones" class="icon star" onclick="refresh()">Posiciones</a>
            </div>
        </div>
    </body>
</html>